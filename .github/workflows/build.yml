name: Build

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/release.yml'
      - '.github/FUNDING.yml'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/release.yml'
      - '.github/FUNDING.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        
      - name: Set up Go
        uses: actions/setup-go@v5.1.0
        with:
          go-version: 1.22.1

      - name: Install deps
        shell: bash
        run: sudo apt-get update && sudo apt-get install gcc libgl1-mesa-dev xorg-dev

      - name: Build for linux
        run: go build -o flxvwr-darwin-x64 .

      - name: Run tests
        run: go test -v ./...

  test-aur:
    runs-on: ubuntu-latest
    steps:
      - name: Get Release Version
        id: get_version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Install Arch Linux Base
        run: |
          sudo apt update
          sudo apt install -y debootstrap
          sudo debootstrap --arch=amd64 arch /mnt/arch http://mirrors.kernel.org/archlinux/$repo/os/$arch

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AURSSH }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan -t rsa aur.archlinux.org >> ~/.ssh/known_hosts
          touch ~/.ssh/config
          echo "Host aur.archlinux.org" >> ~/.ssh/config
          echo "  User aur" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/aur" >> ~/.ssh/config

      - name: Checkout aur repo
        run: |
          git clone ssh://aur@aur.archlinux.org/flxvwr-bin.git

      - name: Cat PKGBUILD (before)
        run: cat flxvwr-bin/PKGBUILD

      - name: Cat .SRCINFO (before)
        run: cat flxvwr-bin/.SRCINFO

      - name: Update Package in Arch Chroot
        run: |
          sudo chroot /mnt/arch /bin/bash <<EOF
          pacman -Sy --noconfirm base-devel git
          cd /workspace/flxvwr-bin
          sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD
          makepkg --printsrcinfo > .SRCINFO
          git add PKGBUILD .SRCINFO
          if ! git diff --cached --quiet; then
            echo "Changes detected"
          else
            echo "No changes to commit"
          fi
          EOF

      - name: Cat PKGBUILD (after)
        run: cat flxvwr-bin/PKGBUILD
        
      - name: Cat .SRCINFO (after)
        run: cat flxvwr-bin/.SRCINFO
